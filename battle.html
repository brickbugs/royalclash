<!DOCTYPE html>
<html>
<head>
  <title>Battle</title>
  <meta charset="UTF-8" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #181818;
      color: #fff;
      text-align: center;
      padding: 40px;
    }
    h1 {
      font-size: 32px;
    }
    .players {
      display: flex;
      justify-content: space-around;
      margin-top: 40px;
    }
    .player-box {
      background-color: #292929;
      padding: 20px;
      border-radius: 12px;
      width: 40%;
    }
    .deck {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
    .card {
      background: #444;
      border: 1px solid #777;
      border-radius: 8px;
      padding: 10px;
      margin: 5px;
      width: 60px;
      height: 80px;
    }
    #startText {
      margin-top: 30px;
      font-size: 22px;
      color: #0f0;
    }
  </style>
</head>
<body>
  <h1>‚öîÔ∏è Battle Begins</h1>
  <div class="players">
    <div class="player-box" id="player1">
      <h2>Player 1</h2>
      <div class="deck" id="deck1"></div>
    </div>
    <div class="player-box" id="player2">
      <h2>Player 2</h2>
      <div class="deck" id="deck2"></div>
    </div>
  </div>

  <div id="startText">Loading battle...</div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyADqsChcYfhT_bAlQ1VWkrlga-oTJViz7U",
      authDomain: "clashroyaleclone-ae764.firebaseapp.com",
      projectId: "clashroyaleclone-ae764",
      storageBucket: "clashroyaleclone-ae764.appspot.com",
      messagingSenderId: "938364278081",
      appId: "1:938364278081:web:1c214bd66caef6d7567dc0",
      measurementId: "G-PT2GPP0JF5"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const lobbyId = localStorage.getItem("lobbyId");
    let currentUser = null;
    let opponentUid = null;

    // Function to declare winner (when opponent leaves)
    async function declareWinner(winnerUid, loserUid, reason) {
      try {
        await db.collection("lobbies").doc(lobbyId).update({
          winner: winnerUid,
          loser: loserUid,
          reason: reason,
          endedAt: firebase.firestore.FieldValue.serverTimestamp(),
          ended: true
        });

        console.log("Winner declared:", winnerUid, reason);
      } catch (err) {
        console.error("Error declaring winner:", err);
      }
    }

    // Redirect to home page after battle ends
    function redirectToHome(message) {
      alert(message);
      localStorage.removeItem("lobbyId");
      window.location.href = "home.html";
    }

    async function loadBattle() {
      if (!lobbyId) {
        document.getElementById("startText").textContent = "‚ùå Lobby ID not found.";
        return;
      }

      try {
        const lobbySnap = await db.collection("lobbies").doc(lobbyId).get();
        const lobbyData = lobbySnap.data();
        if (!lobbyData || lobbyData.players.length < 2) {
          document.getElementById("startText").textContent = "‚ùå Waiting for opponent...";
          return;
        }

        const [uid1, uid2] = lobbyData.players;

        const player1Snap = await db.collection("players").doc(uid1).get();
        const player2Snap = await db.collection("players").doc(uid2).get();

        const player1 = player1Snap.data();
        const player2 = player2Snap.data();

        currentUser = auth.currentUser;
        opponentUid = uid1 === currentUser.uid ? uid2 : uid1;

        // Display usernames
        document.querySelector("#player1 h2").textContent = player1.username;
        document.querySelector("#player2 h2").textContent = player2.username;

        // Load decks
        const deck1 = player1.deck || [];
        const deck2 = player2.deck || [];

        const deck1El = document.getElementById("deck1");
        const deck2El = document.getElementById("deck2");

        deck1El.innerHTML = "";
        deck2El.innerHTML = "";

        for (const card of deck1) {
          const cardEl = document.createElement("div");
          cardEl.className = "card";
          cardEl.textContent = card;
          deck1El.appendChild(cardEl);
        }

        for (const card of deck2) {
          const cardEl = document.createElement("div");
          cardEl.className = "card";
          cardEl.textContent = card;
          deck2El.appendChild(cardEl);
        }

        document.getElementById("startText").textContent = "‚úÖ Battle Ready! (Start your game logic here)";

        // Listen for lobby updates (win/lose)
        db.collection("lobbies").doc(lobbyId).onSnapshot((doc) => {
          const data = doc.data();
          if (data.ended) {
            if (data.winner === currentUser.uid) {
              redirectToHome("üéâ You won the battle!");
            } else if (data.loser === currentUser.uid) {
              redirectToHome("üòû You lost the battle.");
            } else {
              redirectToHome("Battle ended.");
            }
          }
        });

        // Setup unload event: If user leaves, declare opponent winner immediately
        window.addEventListener("beforeunload", async (event) => {
          // Prevent multiple triggers and check lobby exists
          if (!lobbyId || !currentUser || !opponentUid) return;

          try {
            await declareWinner(opponentUid, currentUser.uid, "Opponent left the battle");
          } catch (e) {
            console.error("Error on unload winner declaration:", e);
          }
        });

      } catch (err) {
        console.error(err);
        document.getElementById("startText").textContent = "‚ùå Error loading battle.";
      }
    }

    auth.onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      loadBattle();
    });
  </script>
</body>
</html>
