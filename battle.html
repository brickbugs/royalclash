<!DOCTYPE html>
<html>
<head>
  <title>Battle</title>
  <meta charset="UTF-8" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #181818;
      color: #fff;
      text-align: center;
      padding: 40px;
    }
    h1 {
      font-size: 32px;
    }
    .players {
      display: flex;
      justify-content: space-around;
      margin-top: 40px;
    }
    .player-box {
      background-color: #292929;
      padding: 20px;
      border-radius: 12px;
      width: 40%;
    }
    .deck {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
    .card {
      background: #444;
      border: 1px solid #777;
      border-radius: 8px;
      padding: 10px;
      margin: 5px;
      width: 60px;
      height: 80px;
    }
    #startText {
      margin-top: 30px;
      font-size: 22px;
      color: #0f0;
    }
  </style>
</head>
<body>
  <h1>‚öîÔ∏è Battle Begins</h1>
  <div class="players">
    <div class="player-box" id="player1">
      <h2>Player 1</h2>
      <div class="deck" id="deck1"></div>
    </div>
    <div class="player-box" id="player2">
      <h2>Player 2</h2>
      <div class="deck" id="deck2"></div>
    </div>
  </div>

  <div id="startText">Loading battle...</div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyADqsChcYfhT_bAlQ1VWkrlga-oTJViz7U",
      authDomain: "clashroyaleclone-ae764.firebaseapp.com",
      projectId: "clashroyaleclone-ae764",
      storageBucket: "clashroyaleclone-ae764.appspot.com",
      messagingSenderId: "938364278081",
      appId: "1:938364278081:web:1c214bd66caef6d7567dc0",
      measurementId: "G-PT2GPP0JF5"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const lobbyId = localStorage.getItem("lobbyId");
    let currentUser = null;
    let opponentUid = null;
    let opponentName = null;
    let declaredWinner = false;

    const HEARTBEAT_INTERVAL_MS = 2000; // 2 seconds
    const TIMEOUT_MS = 20000; // 20 seconds

    async function heartbeat() {
      if (!currentUser || !lobbyId) return;
      try {
        await db.collection("lobbies").doc(lobbyId).update({
          [`lastSeen.${currentUser.uid}`]: firebase.firestore.Timestamp.now()
        });
      } catch (e) {
        console.error("Heartbeat error:", e);
      }
    }

    async function declareWinner(winnerUid, loserUid, reason) {
      if (declaredWinner) return; // prevent multiple declarations
      declaredWinner = true;

      const winnerIsYou = winnerUid === currentUser.uid;
      const winnerName = winnerIsYou ? "You" : opponentName;

      document.getElementById("startText").textContent = `üèÜ ${winnerName} win! (${reason})`;

      try {
        // Award coins
        const winnerDocRef = db.collection("players").doc(winnerUid);
        const loserDocRef = db.collection("players").doc(loserUid);

        const winnerDoc = await winnerDocRef.get();
        const loserDoc = await loserDocRef.get();

        const winnerData = winnerDoc.data() || {};
        const loserData = loserDoc.data() || {};

        // Calculate coins reward: normal win = +20, disconnect win = +10 less = +10
        const COINS_FOR_WIN = reason === "Opponent disconnected" ? 10 : 20;

        // Update winner coins
        await winnerDocRef.update({
          coins: (winnerData.coins ?? 0) + COINS_FOR_WIN
        });

        // Optional: You can penalize loser here if you want (not required)

        // Delete lobby doc to clean up
        await db.collection("lobbies").doc(lobbyId).delete();

      } catch (e) {
        console.error("Error updating coins or cleaning lobby:", e);
      }

      setTimeout(() => {
        localStorage.removeItem("lobbyId");
        window.location.href = "home.html";
      }, 5000);
    }

    function checkOpponentHeartbeat(lobbyData) {
      if (!lobbyData) return;
      const lastSeen = lobbyData.lastSeen || {};
      if (!opponentUid || !lastSeen[opponentUid]) return;

      const opponentLastSeen = lastSeen[opponentUid].toMillis();
      const now = Date.now();

      // If opponent lastSeen timestamp is older than TIMEOUT_MS, opponent is disconnected
      if (now - opponentLastSeen > TIMEOUT_MS) {
        declareWinner(currentUser.uid, opponentUid, "Opponent disconnected");
      }
    }

    async function loadBattle() {
      if (!lobbyId) {
        document.getElementById("startText").textContent = "‚ùå Lobby ID not found.";
        return;
      }

      try {
        const lobbySnap = await db.collection("lobbies").doc(lobbyId).get();
        const lobbyData = lobbySnap.data();
        if (!lobbyData || lobbyData.players.length < 2) {
          document.getElementById("startText").textContent = "‚ùå Waiting for opponent...";
          return;
        }

        const [uid1, uid2] = lobbyData.players;

        currentUser = auth.currentUser;
        if (!currentUser) {
          window.location.href = "index.html";
          return;
        }

        // Determine opponent uid
        opponentUid = uid1 === currentUser.uid ? uid2 : uid1;

        // Get player data
        const player1Snap = await db.collection("players").doc(uid1).get();
        const player2Snap = await db.collection("players").doc(uid2).get();

        const player1 = player1Snap.data();
        const player2 = player2Snap.data();

        opponentName = uid1 === currentUser.uid ? player2.username : player1.username;

        // Display usernames
        document.querySelector("#player1 h2").textContent = player1.username;
        document.querySelector("#player2 h2").textContent = player2.username;

        // Load decks
        const deck1 = player1.deck || [];
        const deck2 = player2.deck || [];

        const deck1El = document.getElementById("deck1");
        const deck2El = document.getElementById("deck2");

        deck1El.innerHTML = "";
        deck2El.innerHTML = "";

        for (const card of deck1) {
          const cardEl = document.createElement("div");
          cardEl.className = "card";
          cardEl.textContent = card;
          deck1El.appendChild(cardEl);
        }

        for (const card of deck2) {
          const cardEl = document.createElement("div");
          cardEl.className = "card";
          cardEl.textContent = card;
          deck2El.appendChild(cardEl);
        }

        document.getElementById("startText").textContent = "‚úÖ Battle Ready!";

        // Start heartbeat immediately and repeat every 2 seconds
        heartbeat();
        setInterval(heartbeat, HEARTBEAT_INTERVAL_MS);

        // Listen to lobby updates to monitor opponent heartbeat
        db.collection("lobbies").doc(lobbyId).onSnapshot(doc => {
          if (!doc.exists) return;
          const data = doc.data();

          // Check opponent heartbeat for disconnects
          checkOpponentHeartbeat(data);
        });

        // Detect if current player closes tab/browser and mark disconnect
        window.addEventListener("beforeunload", async (event) => {
          try {
            // Update lobby to remove current player (or mark disconnected)
            const lobbyRef = db.collection("lobbies").doc(lobbyId);
            const lobbyDoc = await lobbyRef.get();
            if (!lobbyDoc.exists) return;

            const lobbyData = lobbyDoc.data();

            if (lobbyData.players.includes(currentUser.uid)) {
              // Remove player from lobby.players array
              const updatedPlayers = lobbyData.players.filter(uid => uid !== currentUser.uid);

              await lobbyRef.update({
                players: updatedPlayers
              });

              // Optionally update lastSeen to distant past to force disconnect detection
              await lobbyRef.update({
                [`lastSeen.${currentUser.uid}`]: firebase.firestore.Timestamp.fromMillis(0)
              });
            }
          } catch (e) {
            console.error("Error during unload:", e);
          }
        });

      } catch (err) {
        console.error(err);
        document.getElementById("startText").textContent = "‚ùå Error loading battle.";
      }
    }

    auth.onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      loadBattle();
    });
  </script>
</body>
</html>
