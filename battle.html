<!DOCTYPE html>
<html>
<head>
  <title>Battle</title>
  <meta charset="UTF-8" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #181818;
      color: #fff;
      text-align: center;
      padding: 40px;
    }
    h1 {
      font-size: 32px;
    }
    .players {
      display: flex;
      justify-content: space-around;
      margin-top: 40px;
    }
    .player-box {
      background-color: #292929;
      padding: 20px;
      border-radius: 12px;
      width: 40%;
    }
    .deck {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
    .card {
      background: #444;
      border: 1px solid #777;
      border-radius: 8px;
      padding: 10px;
      margin: 5px;
      width: 60px;
      height: 80px;
    }
    #startText {
      margin-top: 30px;
      font-size: 22px;
      color: #0f0;
    }
  </style>
</head>
<body>
  <h1>‚öîÔ∏è Battle Begins</h1>
  <div class="players">
    <div class="player-box" id="player1">
      <h2>Player 1</h2>
      <div class="deck" id="deck1"></div>
    </div>
    <div class="player-box" id="player2">
      <h2>Player 2</h2>
      <div class="deck" id="deck2"></div>
    </div>
  </div>

  <div id="startText">Loading battle...</div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyADqsChcYfhT_bAlQ1VWkrlga-oTJViz7U",
      authDomain: "clashroyaleclone-ae764.firebaseapp.com",
      projectId: "clashroyaleclone-ae764",
      storageBucket: "clashroyaleclone-ae764.appspot.com",
      messagingSenderId: "938364278081",
      appId: "1:938364278081:web:1c214bd66caef6d7567dc0",
      measurementId: "G-PT2GPP0JF5"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const lobbyId = localStorage.getItem("lobbyId");

    let currentUser;
    let opponentUid;
    let opponentName;

    const HEARTBEAT_INTERVAL_MS = 3000; // How often we update "lastSeen"
    const TIMEOUT_MS = 10000; // How long to wait before declaring opponent disconnected

    // Update our lastSeen timestamp every few seconds
    async function heartbeat() {
      if (!currentUser || !lobbyId) return;
      try {
        await db.collection("lobbies").doc(lobbyId).update({
          [`lastSeen.${currentUser.uid}`]: firebase.firestore.Timestamp.now()
        });
      } catch (e) {
        console.error("Heartbeat error:", e);
      }
    }

    async function declareWinner(winnerUid, loserUid) {
      try {
        // Give winner coins (less than normal reward)
        const winnerDoc = await db.collection("players").doc(winnerUid).get();
        const winnerData = winnerDoc.data();
        const currentCoins = winnerData.coins ?? 0;
        const reward = 40; // example regular reward is 50, this is 10 less

        await db.collection("players").doc(winnerUid).update({
          coins: currentCoins + reward
        });

        // Update UI
        document.getElementById("startText").textContent = `üèÜ ${winnerUid === currentUser.uid ? "You" : opponentName} win! (Opponent disconnected)`;
        
        // Clean up lobby (optional: delete lobby)
        await db.collection("lobbies").doc(lobbyId).delete();

        // Redirect to home after 5 seconds
        setTimeout(() => {
          localStorage.removeItem("lobbyId");
          window.location.href = "home.html";
        }, 5000);
      } catch (e) {
        console.error("Error declaring winner:", e);
      }
    }

    async function loadBattle() {
      if (!lobbyId) {
        document.getElementById("startText").textContent = "‚ùå Lobby ID not found.";
        return;
      }

      try {
        const lobbyRef = db.collection("lobbies").doc(lobbyId);

        const lobbySnap = await lobbyRef.get();
        const lobbyData = lobbySnap.data();
        if (!lobbyData || lobbyData.players.length < 2) {
          document.getElementById("startText").textContent = "‚ùå Waiting for opponent...";
          return;
        }

        const [uid1, uid2] = lobbyData.players;
        currentUser = auth.currentUser;

        // Determine opponent uid
        opponentUid = uid1 === currentUser.uid ? uid2 : uid1;

        // Fetch player data
        const [player1Snap, player2Snap] = await Promise.all([
          db.collection("players").doc(uid1).get(),
          db.collection("players").doc(uid2).get()
        ]);

        const player1 = player1Snap.data();
        const player2 = player2Snap.data();

        opponentName = (uid1 === currentUser.uid) ? player2.username : player1.username;

        // Display usernames
        document.querySelector("#player1 h2").textContent = player1.username;
        document.querySelector("#player2 h2").textContent = player2.username;

        // Load decks
        const deck1 = player1.deck || [];
        const deck2 = player2.deck || [];

        const deck1El = document.getElementById("deck1");
        const deck2El = document.getElementById("deck2");

        for (const card of deck1) {
          const cardEl = document.createElement("div");
          cardEl.className = "card";
          cardEl.textContent = card;
          deck1El.appendChild(cardEl);
        }

        for (const card of deck2) {
          const cardEl = document.createElement("div");
          cardEl.className = "card";
          cardEl.textContent = card;
          deck2El.appendChild(cardEl);
        }

        document.getElementById("startText").textContent = "‚úÖ Battle Ready! (Start your game logic here)";

        // Start heartbeat to update lastSeen
        setInterval(heartbeat, HEARTBEAT_INTERVAL_MS);

        // Listen for disconnects:
        lobbyRef.onSnapshot(doc => {
          const data = doc.data();
          if (!data) return;

          const lastSeen = data.lastSeen || {};
          const now = Date.now();

          const opponentLastSeen = lastSeen[opponentUid] ? lastSeen[opponentUid].toDate().getTime() : 0;

          // If opponent hasn't updated lastSeen within TIMEOUT_MS, we win
          if (now - opponentLastSeen > TIMEOUT_MS) {
            declareWinner(currentUser.uid, opponentUid);
          }
        });

      } catch (err) {
        console.error(err);
        document.getElementById("startText").textContent = "‚ùå Error loading battle.";
      }
    }

    auth.onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      loadBattle();
    });
  </script>
</body>
</html>
