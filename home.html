<script>
  const firebaseConfig = {
    apiKey: "AIzaSyADqsChcYfhT_bAlQ1VWkrlga-oTJViz7U",
    authDomain: "clashroyaleclone-ae764.firebaseapp.com",
    projectId: "clashroyaleclone-ae764",
    storageBucket: "clashroyaleclone-ae764.appspot.com",
    messagingSenderId: "938364278081",
    appId: "1:938364278081:web:1c214bd66caef6d7567dc0",
    measurementId: "G-PT2GPP0JF5",
    databaseURL: "https://clashroyaleclone-ae764-default-rtdb.firebaseio.com"
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();
  const rtdb = firebase.database();

  const usernameEl = document.getElementById("username");
  const coinsEl = document.getElementById("coins");
  const battleButton = document.getElementById("battleButton");
  const cancelSearchButton = document.getElementById("cancelSearchButton");
  const matchStatus = document.getElementById("matchStatus");

  let matchListener = null;

  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      window.location.href = "index.html";
      return;
    }

    // Load player data from Firestore
    const doc = await db.collection("players").doc(user.uid).get();
    const data = doc.data();

    usernameEl.textContent = `üë§ Username: ${data?.username ?? "Unknown"}`;
    coinsEl.textContent = `üí∞ Coins: ${data?.coins ?? 0}`;
  });

  function logout() {
    auth.signOut().then(() => {
      window.location.href = "index.html";
    });
  }

  function goToDeck() {
    window.location.href = "deck.html";
  }

  // Clear localStorage match info on page load (prevent stale data)
  localStorage.removeItem("matchId");
  localStorage.removeItem("matchCreator");

  // Listen for incoming match assignment from RTDB
  function startMatchListener(uid) {
    if (matchListener) matchListener.off();
    matchListener = rtdb.ref(`/matches/${uid}`);
    matchListener.on("value", (snapshot) => {
      const matchData = snapshot.val();
      if (matchData && matchData.matchId && matchData.matchCreator) {
        matchStatus.textContent = "‚úÖ Match found! Redirecting...";

        // Save match info for battle.html to load
        localStorage.setItem("matchId", matchData.matchId);
        localStorage.setItem("matchCreator", matchData.matchCreator);

        // Clean up match data for this user
        rtdb.ref(`/matches/${uid}`).remove();

        // Redirect to battle page with query param (optional)
        window.location.href = `battle.html?matchId=${matchData.matchId}`;
      }
    });
  }

  async function joinQueue(uid) {
    const queueRef = rtdb.ref("/matchmakingQueue");
    const snapshot = await queueRef.once("value");
    const queue = snapshot.val() || {};

    // Look for opponent waiting in queue who is NOT this uid
    const otherUid = Object.keys(queue).find(id => id !== uid);

    if (otherUid) {
      // Match found: create a unique matchId
      const matchId = rtdb.ref().push().key;

      // Determine match creator (we'll assign player with lex smaller uid as creator for consistency)
      const matchCreator = uid < otherUid ? uid : otherUid;

      // Create matches entries for both players with matchId and matchCreator
      await Promise.all([
        rtdb.ref(`/matches/${uid}`).set({ matchId, matchCreator, opponent: otherUid }),
        rtdb.ref(`/matches/${otherUid}`).set({ matchId, matchCreator, opponent: uid }),
        rtdb.ref(`/matchmakingQueue/${otherUid}`).remove()
      ]);
      return { matched: true, matchId, matchCreator };
    } else {
      // No opponent, add self to matchmaking queue
      await rtdb.ref(`/matchmakingQueue/${uid}`).set(true);
      return { matched: false };
    }
  }

  battleButton.addEventListener("click", async () => {
    battleButton.disabled = true;
    cancelSearchButton.style.display = "inline-block";
    matchStatus.textContent = "üîç Searching for an opponent...";

    const user = auth.currentUser;
    if (!user) return;

    const result = await joinQueue(user.uid);

    if (result.matched) {
      // Save match info locally and redirect immediately
      localStorage.setItem("matchId", result.matchId);
      localStorage.setItem("matchCreator", result.matchCreator);

      matchStatus.textContent = "‚úÖ Match found! Redirecting...";
      window.location.href = `battle.html?matchId=${result.matchId}`;
    } else {
      // No immediate match, listen for matchmaking result
      startMatchListener(user.uid);

      // Timeout after 30 seconds of no match
      setTimeout(() => {
        cancelSearch();
        matchStatus.textContent = "‚ùå No opponents found.";
      }, 30000);
    }
  });

  async function cancelSearch() {
    const user = auth.currentUser;
    if (!user) return;

    if (matchListener) {
      matchListener.off();
      matchListener = null;
    }

    await rtdb.ref(`/matchmakingQueue/${user.uid}`).remove();

    matchStatus.textContent = "‚ùå Matchmaking cancelled.";
    battleButton.disabled = false;
    cancelSearchButton.style.display = "none";
  }

  cancelSearchButton.onclick = cancelSearch;
</script>
