<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Home - Clash Royale Clone</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      text-align: center;
      padding: 40px;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, addDoc, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyADqsChcYfhT_bAlQ1VWkrlga-oTJViz7U",
      authDomain: "clashroyaleclone-ae764.firebaseapp.com",
      projectId: "clashroyaleclone-ae764",
      storageBucket: "clashroyaleclone-ae764.appspot.com",
      messagingSenderId: "290948682331",
      appId: "1:290948682331:web:fd0731ab8e38553e93c45f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUserId = null;

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUserId = user.uid;
        document.getElementById("user-info").textContent = "Logged in as: " + user.uid;
      } else {
        window.location.href = "login.html";
      }
    });

    async function findOrCreateLobby() {
      const lobbiesRef = collection(db, "lobbies");

      // Try to find open lobby not made by this user
      const q = query(lobbiesRef, where("status", "==", "open"), where("creator", "!=", currentUserId));
      const querySnapshot = await getDocs(q);

      if (!querySnapshot.empty) {
        const lobbyDoc = querySnapshot.docs[0];
        await updateDoc(lobbyDoc.ref, {
          status: "full",
          player2: currentUserId,
        });
        window.location.href = `battle.html?matchId=${lobbyDoc.id}`;
      } else {
        // Create a new lobby
        const newLobby = await addDoc(lobbiesRef, {
          creator: currentUserId,
          status: "open",
          createdAt: Date.now()
        });
        waitForOpponent(newLobby.id);
      }
    }

    function waitForOpponent(lobbyId) {
      const interval = setInterval(async () => {
        const docRef = doc(db, "lobbies", lobbyId);
        const snapshot = await getDocs(query(collection(db, "lobbies"), where("__name__", "==", lobbyId)));
        const lobby = snapshot.docs[0];
        if (lobby && lobby.data().status === "full") {
          clearInterval(interval);
          window.location.href = `battle.html?matchId=${lobbyId}`;
        }
      }, 1000);
    }

    async function logout() {
      await signOut(auth);
      window.location.href = "login.html";
    }

    function goToDeck() {
      window.location.href = "deck.html";
    }

    window.findOrCreateLobby = findOrCreateLobby;
    window.logout = logout;
    window.goToDeck = goToDeck;
  </script>
</head>
<body>
  <h1>Welcome to Clash Royale Clone</h1>
  <div id="user-info">Loading...</div>
  <button onclick="findOrCreateLobby()">Find Match</button>
  <button onclick="goToDeck()">Go to Deck</button>
  <button onclick="logout()">Logout</button>
</body>
</html>
